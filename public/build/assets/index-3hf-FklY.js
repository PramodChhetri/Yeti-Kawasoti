import{W as O,r as i,j as e}from"./app-CeHawWK7.js";import{I as y}from"./InputError-B_B1jo66.js";import{B as R}from"./button-CBFDvSSe.js";import{L as b}from"./label-DZHSVrJR.js";import{T as C}from"./textarea-CDpx1joq.js";import{A as P}from"./AuthenticatedLayout-vtNVav6n.js";import{t as m}from"./use-toast-TciExXPv.js";import T from"./FilterDialog-CF7ageU0.js";import"./index-Clynsdhc.js";import"./index-Bb4qSo10.js";import"./utils-CRrpu23W.js";import"./index-B_ku7PSA.js";import"./GlobalLayout-Cfd5osqe.js";import"./toaster-B8JIrNCo.js";import"./index-DD1TA57H.js";import"./index-JWIwkwlr.js";import"./x-CcTwlrmH.js";import"./createLucideIcon-T09ZsU69.js";import"./card-m7sUhe83.js";import"./sheet-BX0QfvEQ.js";import"./index-DmAnl5gc.js";import"./index-C9wzw3Ty.js";import"./dropdown-menu-d9Baeyf4.js";import"./index-BBHitacn.js";import"./index-CRFetRKe.js";import"./check-U2lRsC70.js";import"./door-open-DwydA0Yd.js";import"./dialog-vdBOxT0G.js";import"./checkbox-CkOFPeYk.js";import"./input-iG9gLFRb.js";import"./segmented-control-BJ3PsD5-.js";import"./select-CrO88sMk.js";import"./scroll-area-CGdfJqqN.js";import"./filter-DSXKKHjN.js";const xt=({auth:S,sms_balance:d,packages:A,contacts:o,recipientType:c,error:p,...f})=>{const{data:s,setData:l,errors:h,post:E,processing:N,reset:F}=O({contacts:o||[],message:"",recipient_type:c||"members"}),[x,j]=i.useState(1),[M,v]=i.useState(160),[g,_]=i.useState(!1);i.useEffect(()=>{const t=s.message.length,r=Math.max(Math.ceil(t/160),1),a=Array.isArray(s.contacts)?s.contacts.filter(n=>n&&n.trim()!=="").length:0;console.log("Recalculating pages:",{messageLength:t,validContactsCount:a,newTotalPages:r,contacts:s.contacts}),j(r),v(r*160)},[s.message,s.contacts]);const w=Object.keys(f).filter(t=>t.startsWith("member_")||t.startsWith("official_")||t==="membership_package_id"||t==="position").reduce((t,r)=>(t[r]=f[r],t),{});i.useEffect(()=>{p&&m({title:"Error",description:p,variant:"destructive"})},[p]),i.useEffect(()=>{if(console.log("Contacts prop received:",o),o){let t=[];Array.isArray(o)?t=o:typeof o=="object"&&(t=Object.values(o).filter(a=>typeof a=="string"&&a.trim()!=="").map(a=>a.trim()));const r=t.filter((a,n,u)=>u.indexOf(a)===n);console.log("Processed contacts:",{original:o,processed:r,count:r.length}),l("contacts",r)}else console.log("No contacts received, setting empty array"),l("contacts",[])},[o]),i.useEffect(()=>{c&&l("recipient_type",c)},[c]),i.useEffect(()=>{console.log("Form data updated:",s),console.log("Current contacts:",s.contacts)},[s]);const D=t=>{if(t.preventDefault(),!s.contacts.length||!s.message.trim()){m({title:"Validation Error",description:"Contacts and Message are required",variant:"destructive"});return}console.log("Submitting with contacts:",s.contacts),E("/send-message",{onSuccess:()=>{m({title:"Success",description:"Message sent successfully"}),F(),j(1),v(160)},onError:r=>{console.error("Error submitting:",r),m({title:"Error",description:"Failed to send message: "+Object.values(r).join(", "),variant:"destructive"})}})},L=()=>{if(!s.contacts)return console.log("Contacts is undefined"),"";let t=[];Array.isArray(s.contacts)?t=s.contacts:typeof s.contacts=="object"&&(t=Object.values(s.contacts).filter(a=>typeof a=="string"&&a.trim()!=="").map(a=>a.trim()));const r=t.filter((a,n,u)=>u.indexOf(a)===n);return console.log("Valid contacts for display:",r),r.join(", ")};return e.jsxs(P,{user:S.user,children:[e.jsxs("header",{className:"flex justify-between",children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Send Message"}),d<0?e.jsx("span",{className:"text-muted-foreground",children:"SMS service unavailable"}):e.jsxs("span",{className:"text-card-foreground",children:["Balance: Rs ",d]})]}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx(T,{packages:A,initialRecipientType:c,initialFilters:w})}),e.jsxs("form",{className:"space-y-3 mt-4",onSubmit:D,children:[e.jsxs("div",{children:[e.jsx(b,{htmlFor:"contacts",children:"Contacts"}),e.jsx(C,{id:"contacts",required:!0,value:L(),onChange:t=>{const r=t.target.value?t.target.value.split(",").map(a=>a.trim()).filter(a=>a!==""):[];console.log("Setting new contacts:",r),l("contacts",r)},placeholder:"Comma Separated contact numbers",disabled:g}),e.jsx(y,{message:h.contacts}),e.jsxs("div",{className:"flex justify-between text-muted-foreground text-sm mt-1",children:[e.jsx("div",{children:Array.isArray(s.contacts)&&e.jsx(e.Fragment,{children:e.jsxs("span",{children:["Total contacts:"," ",s.contacts.filter(t=>t&&t.trim()!=="").length]})})}),g&&e.jsx("span",{children:"Loading contacts..."})]})]}),e.jsxs("div",{children:[e.jsx(b,{htmlFor:"message",children:"Message"}),e.jsx(C,{id:"message",required:!0,value:s.message,onChange:t=>{l("message",t.target.value)},placeholder:"Enter message to the recipients"}),e.jsx(y,{message:h.message}),e.jsxs("div",{className:"text-muted-foreground mt-2 flex justify-between",children:[e.jsxs("span",{children:["Total Pages: ",x," - (Rs"," ",(x*(Array.isArray(s.contacts)?s.contacts.filter(t=>t&&t.trim()!=="").length:0)*1.4).toFixed(2),")"]}),e.jsxs("span",{children:[s.message.length," / ",M]})]})]}),e.jsx(R,{type:"submit",disabled:d<=0||N||g||!s.contacts.length,children:"Send SMS Alert"})]})]})};export{xt as default};
